const input = `
..................#................................................................#........#.....................................
...#...........#...................................................#........................................#.................#...
...................................#................#.#...............#.................................................#.........
.....#......#................#.....................................................................#..........#........#......#...
............................................................................................#.....................#...............
.....................#..##...#........................#.................#.......................#..#.........#.......#...#......#.
............##....................................##..................#...............................#....#......................
.............#............#.#..#.......#...........#..............#...............#.....#.........................................
....................#..........##.........#.........#................#............................................................
....#.......#................................................................#...#.#..........................................#.#.
..#..............#.....................................#..........#.#....#..............#..................#.#............#.......
.#.......#.........................#........................#..#.....#............................................................
........#...#......................#...........#......................................#....................#......................
.............................#..............#........##....#....................#......#....................#............#......#.
..............#..............#............#.......................##....#..........................................#.........#....
.............#............#..........#..........#...#.....................................................#.......................
..#........#.....#..........................................#................................................#...#.#...#..........
........#.....................#...#..#......#.........................................................#.....##.........#..........
..............................................................................................#...#...............................
..#.......................#..........................#......#...................................................................#.
.......#.........................#..............#.........#.............#.......................................#...#.............
..................#.................#.......................#....................#....................................#...........
...#...#.......#......##.#...............#....#..............#..........................................#....#..#.................
#................................#.......#.....#.......#.............#..................#........#................................
...........#..................................#.......................................................................#.#..#......
.......#........#.........................................#..........................#...........................#.....#..........
................#..#.....................#..#...........................#...........................................#.............
#...#.......................#................................................#................#................................#..
..........#...........................#.......#............................................................................#.....#
..................................#............................................................#..................................
......................#........#.............#....#.....#.......#..........................#..........................#...........
...........................##.................#.............#........................#...#..................#.....................
.............................................................................................................#....#..........#....
................#...................................#...........#..........#....................#............................#....
........#....#................................................#................##..#..................................#...........
...........#....................................................#...#.#......#....................................................
.......................#.........................................................^....................................#...........
..........................#.............##..#........#.#....#.......#....................#...........#.........#.....#............
........#...........................#..#..........................................................#...............................
....#....................................#....#.........................................#.........#...............................
...............#...................................#.....#.................................#....................................#.
......#...............................................................#.............................#........................#....
.........................#.....#.........................#.#...............#.........#.....#..................#..#.........#......
.........................................................#......#........##.......................#...#......#................#...
.......................................#.....#.................................#..................................................
..................#..................................#..........................................................................#.
...................#....#.........#.......#................#....................#.........................#......#.....#..#.......
................................#..............................................................................#....#.............
.....................#.#.............#.................#..........#.......#.........................................#.............
......#....................#....................................................................#...#.............................
........#........#...........#.##.............#........................#............#..............#.........#....#........#......
........................#.................................................................#.......................................
............................................................#.....#....................#............#.....#....#............#.....
...........#............#....#........................................................##............#..............#..............
...........#...........#.....#..............#..............##....#........#......#................................................
..#................................................................................#......................#......#................
....................#.........#......................#.............................#.......#.......................#.............#
..#...#....#......................................................................................................#...............
...........#................................................................................#...............................#.....
....................................#............#..........#.........................#..................................#.......#
...................#......#...................#............#......#........#................#.............#...........#.........#.
........................#..................................#........#..................#..........................................
............#..#...........#..................##....................#...........................................#.................
.......................................................................................#.....#............#.......................
...............................................#....#................................#..#..........................#..#...........
..............#..#.....#.........#....................#.......#..#..............#...............................#.....#...........
..........#............................#..........................................................................................
........................................#........#........................................................#.#.....................
#................#......................#..................................................................................#......
...............................................................................#................................#.................
...................................................................................................................#.#........#...
#........................................................................#......................................#.#...............
...#......#............#...................#.............#........#..........................................#......#.............
..............##....#...................................................#......................#..................................
...............#........................................................................#...........#...#.#.......................
..........#.#.....#................................#...........#........#.......#.................................................
#....................#......................................................................................#.....................
..............#...##...........................................#.............#.......#..................#..............#..........
.#.............................................#..............................................................................#...
...#................................#............................................#............................#...................
..............................#......................................................#..........................................#.
...................#.....................................#..................................#......#..............................
....#.#..........##.............#.......#........................##..........#.................#..................................
#..#................#........##....................................................................................#..............
........#...#.........................................................................#...........................................
......................................................#....#...................#..#.................................#.............
........#...............#........#..............................................#............................#....................
...#..............................#.........................................##.......................................#....#.......
...#................#..............#.......#......................................................................................
........#..................#.............................................................#...........................#....#.......
......................#.#..........#.......#..................................#..#...#............#...............#...............
.....#..................#....#..#......#.......................#.....................................................#............
.....#................................#.........................#..................#.#..........#...#............#.....#..........
....#...................#....#.#.........#........#..................................................................#....#..#....
........#...............#......................................#........#..............................#..........................
....#...#.#.....#..............#..................#..........#...#..#......................#...#..........#......................#
...........#...................................................................................................#................#.
.................................##..............#.............................#...............................#..................
...........#.................#.............##...................................#.......................#.................##......
.....#..................#......#........#.................................................#..#........................#..#........
......#.......#......................................................................#.#.........#....#...........................
..................#.#........................#......#................................................................#......#.....
.....................#............#...................#.....#....................................#.......#..........#.......#.....
#.............................#...............................#...#...............................................................
..##.........#........#......................................#.....................#...#.............#............#..#............
..........#.....................#..#....................#...#....................#....................#.....................#.....
...........#..........#...............#..#..........#..............................................#.#............................
............#...#...#.............#.........#.............................#...............#.......................................
.........#...........#...............................................................#............................................
.#..#.................................................................#............#.#.......................##...................
........##............#...................#................................#......................................................
............................................#..........................#..........................................................
#...................#...........#..............#...#............#.#........#.................#......#.............................
........#....................................#....................................................................................
...........#.........#..#...............#...........#.....##.#......#....##............#....#....#.#.........##.........#.........
..#......................#..........#.................#.................#......#.............................#........#...........
....................#.................#....#..............................#....#.............#....#....#.....................#....
............#.................#.................................#...............................#..#...........................#..
...................................................#.....#..............#.......#....................#.#..........................
..#.........##..#........#...................................................................................#............#.......
.....#..............................#......................................................................#........#.............
................................#........##.......#...............#..............#.......#...#.#........#.........................
..............................#.....................#.........................................#..................................#
...........#...................##.................#.................................#...............................#........#....
..............................#...##......#..................#...#................................#......#.......#...............#
.....................##......#......#.#.......#..............#......#.................#.........#...................#.............
..........................#................................#...........#..........................................................
...#.....#....................#.....................#...#.....#.............................#.#....#.....#.#.................#....
............................#...#........#......................................................................#.....#...........
............#..........##..................#.............................................................#.....#..#...............
`;

const input2 = `
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
`;

const visited = new Set();

const DIRECTION = {
  up: 0,
  right: 1,
  down: 2,
  left: 3,
};

function findGuardPosition(map) {
  for (const row in map) {
    for (const col in map[row]) {
      if (map[row][col] === "^") {
        return { col: parseInt(col), row: parseInt(row) }
      }
    }
  }
  throw new Error("No guard found");
}

function getNextPosition(col, row, direction) {
  switch (direction) {
    case DIRECTION.up:
      return { col, row: row - 1 };
    case DIRECTION.down:
      return { col, row: row + 1 };
    case DIRECTION.left:
      return { col: col - 1, row };
    case DIRECTION.right:
      return { col: col + 1, row };
  }
}

function isLoop(col, row, direction) {
  return visited.has(JSON.stringify({ col, row, direction }));
}

function isInsideMap(map, col, row) {
  return col >= 0 && col < map[0].length && row >= 0 && row < map.length;
}

function step(map, col, row, direction, loopChecking=false) {
  const next = getNextPosition(col, row, direction);
  if (!isInsideMap(map, next.col, next.row)) {
    return { isOutside: true };
  }
  if (loopChecking && isLoop(next.col, next.row, direction)) {
    return { isLoop: true };
  }
  if (map[next.row][next.col] === "#") {
    return turn (col, row, direction);
  }
  return walk(next.col, next.row, direction, loopChecking);
}

function walk(col, row, direction, loopChecking) {
  addVisitedCell(col, row, loopChecking ? direction : undefined);
  return {
    col,
    row,
    direction,
  }
}

function turn(col, row, direction) {
  return {
    col,
    row,
    direction: (direction + 1) % 4,
  }
}

function addVisitedCell(col, row, direction) {
  visited.add(JSON.stringify({ col, row, direction }));
}

function day06(input) {
  const map = input.trim().split("\n");
  let { col, row } = findGuardPosition(map);
  addVisitedCell(col, row);
  let direction = DIRECTION.up;
  let isOutside = false;

  while (!isOutside) {
    ({ isOutside, col, row, direction } = step(map, col, row, direction));
  }

  return visited.size;
}

function createMapWithNewObstacle(map, col, row) {
  const nextMap = JSON.parse(JSON.stringify(map));
  const tmp = nextMap[row].split("");
  tmp[col] = "#";
  nextMap[row] = tmp.join("");
  return nextMap;
}

function day06_02(input) {
  const map = input.trim().split("\n");
  let count = 0;
  day06(input);
  visited.delete(JSON.stringify(findGuardPosition(map)));
  for (const key of [...visited.values()]) {
    const nextObstaclePosition = JSON.parse(key);

    visited.clear();
    const nextMap = createMapWithNewObstacle(
      map,
      nextObstaclePosition.col,
      nextObstaclePosition.row
    );
    let { col, row } = findGuardPosition(map);
    let direction = DIRECTION.up;
    let isOutside = false;
    let isLoop = false;

    while (!isOutside && !isLoop) {
      ({ isOutside, col, row, direction, isLoop } = step(
        nextMap,
        col,
        row,
        direction,
        true
      ));
    }
    if (isLoop) {
      count++;
    }
  }
  return count;
}


console.log(day06(input)); //4656
console.log(day06_02(input)); //1575
